---
title: "Final"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Packages

```{r}
library(tidyverse)
library(rvest)
```

## Data 

```{r, message=FALSE}
masters <- read_csv("Data/Master.csv")
coaches <- read_csv("Data/Coaches.csv")
awardCoaches <- read_csv("Data/AwardsCoaches.csv")
teams <- read_csv("Data/Teams.csv")
teamsPost <- read_csv("Data/TeamsPost.csv")

wiki <- read_html("https://en.wikipedia.org/wiki/List_of_Stanley_Cup_champions")

SC <- html_nodes(wiki, css = "table")

sc_data <- html_table(SC, header = T, fill = T)[[3]]
                 
```

#Tanush
```{r}
#selecting NHL
teams_F <- teams %>% filter(lgID == "NHL")
teamsPost_F <- teamsPost %>% filter(lgID == "NHL")

# # | tmID=="LAK" | tmID=="BOS"
# teams_F %>% filter(tmID=="MTL") %>% ggplot(aes(year, W/G)) + geom_point(aes(color=(playoff=="SC"))) + geom_line(alpha =0.6) + labs(y="Wins Proportion") + labs(title = "MTL Record")
# 
# teams_F %>% filter(playoff =="SC") %>% ggplot(aes(year, W/G)) + geom_point(aes(color=tmID)) + geom_smooth()+ labs(title = "Stanley Cup Winners", y="Proportion of games won")

```

#Zach
```{r}
#Coach Awards Data set

awardCoaches2 <- awardCoaches %>% 
  filter(award == "Jack Adams") %>% 
  select(-note)

masters_names <- masters %>% 
  select(coachID, firstName, lastName)

awardCoaches_f <- left_join(awardCoaches2, masters_names)

#Postseason Data set

```


#Pete

```{r}
coaches = coaches %>% filter(lgID == "NHL")
coaches1 = coaches %>% 
  filter(lgID == "NHL") %>% 
  group_by(coachID) %>% 
  summarise(number_of_years_in_league = (1+max(year)-min(year)))

coaches2 = coaches %>% 
  filter(lgID == "NHL") %>% 
  group_by(coachID) %>% 
  summarise(reg_overall_win = sum(w), reg_overall_loss = sum(l), reg_overall_tie = sum(t), reg_num_game = sum(g))

coaches3 = coaches %>% 
  filter(lgID == "NHL") %>% 
  group_by(coachID) %>% 
  summarise(post_overall_win = sum(postw), post_overall_loss = sum(postl), post_overall_tie = sum(postt), post_num_game = sum(postg))

coaches4 = coaches1 %>% 
  full_join(coaches2, by = "coachID") %>%
  full_join(coaches3, by = "coachID")

coaches_f = coaches4 %>% 
  mutate(reg_win_percent = (reg_overall_win/reg_num_game), post_win_percent = post_overall_win/post_num_game) %>% 
  select(coachID:reg_overall_tie, reg_win_percent, post_overall_win:post_overall_tie,post_win_percent)

```

#Question 1  
How does the team performance change after the coach wins the Jack Adams award?  
**answer**  
```{r}
#every coach for every year
test1 = coaches %>% 
  full_join(awardCoaches, by = c("coachID","year","lgID")) %>% 
  filter(lgID == "NHL") %>% 
  full_join(teams, by = c("year","tmID","lgID")) %>% 
  mutate(won_award = !is.na(award)) %>% 
  select(coachID,year,tmID,g,w,l,t,award,won_award) %>% 
  filter(is.na(coachID)==FALSE, year >= 1995, year <=2000) %>%                   #doesn't look like jack adams started until 1973
  arrange(year)
test1

#all the coaches that have won an award
test2 <- test1 %>% 
  filter(won_award == TRUE) %>% 
  arrange(year)
test2


printPlot <- function(tibble) {
  print(ggplot(tibble, aes(year, ((2*W+T)/(2*G)))) + geom_line() + labs(y ="Points Percentage", title = paste(tibble$tmID[1], "after their coach won Jack Adams award in", tibble$year[1], sep = " ")))

  }

for(x in 1:nrow(test2)){
  teams_F %>%  filter(tmID==test2$tmID[x] & year >= test2$year[x] & year <= (test2$year[x]+5)) %>% printPlot(.)
}


```

 
#Question 2  
How does the team performance change after winning a Stanley Cup?  
**answer**  
In the graph below, the blue line represents the percentage of total possible points per game that the team that won the Stanley Cup the previous year earns. The red line represents the percentage of total possible  points per game for the rest of the league. Therefore, since the average points per game for all but three years since 1987 is higher for the reigning league champions than the rest of the NHL, team performance tends to remain high for teams that have just won a Stanley Cup the year before.  
```{r, warning=FALSE, message=FALSE}
#stantley cup champion, year + 1 to be able to join with another dataset
#to see how they do the next year

#filtering for SC champs in modern playoff structure (needs 16 wins to get Stanley cup)
scChamps <- teamsPost %>% 
  filter(year < 2011, W == 16) %>% 
  select(year, tmID) %>% 
  mutate(year = year + 1)

#filtering reg season data
regSeason <- teams %>%
  select(year, tmID, Pts, G) %>% 
  filter(year > 1987) %>% 
  group_by(year) %>% 
  mutate(meanPtsPct = mean(Pts/(2*G)), PtsPct = Pts/(2*G))

data_f <- left_join(scChamps, regSeason, by = c("year","tmID"))

#points needed for playoffs
playoffpts <- teams %>%
select(year, tmID, Pts, G, rank) %>%
filter(year > 1987, rank == 4, year != 2004 , year != 2005) %>%
group_by(year) %>%
summarise(PtsForPlayoffs = mean(Pts/ (2*G)))

data_f <- left_join(data_f, playoffpts)

#MAYBE CHANGE THIS TO PTS %????
ggplot(data_f) +
  geom_line(aes(year, PtsPct), col = "blue") +
  geom_point(aes(year, PtsPct), col = "blue") +
  geom_line(aes(year, PtsForPlayoffs), col = "red") +
  geom_point(aes(year, PtsForPlayoffs), col = "red")
```

```{r}
origSix <- teams %>% 
  filter(tmID == "BOS" | tmID == "MTL" | tmID == "DET" |
           tmID == "CHI" | tmID == "TOR" | tmID == "CHI") %>% 
  select(year, tmID, G, Pts, playoff, name) %>% 
  mutate(PtsPct = Pts / (2*G))
  
SC <- origSix %>% 
  filter(playoff == "SC")
  
ggplot(origSix, aes(year, PtsPct, col = tmID)) +
  geom_line() +
  geom_point(data = SC, aes(year, PtsPct), col = "black") +
  facet_wrap(~tmID)

teams %>% 
  filter(year >= 1990) %>% 
  right_join(champs96_00, by = "tmID") %>% 
  select(year.x, tmID, G, Pts, year.y) %>% 
  rename(year = year.x, SCyear = year.y) %>% 
  mutate(PtsPct = Pts / (2*G)) %>% 
  ggplot(aes(year, PtsPct, col = tmID)) +
  geom_line() +
  geom_point(aes(SCyear, PtsPct), col = "black") +
  facet_wrap(~tmID)
```


#Question 3  
What coach coached the same team for the longest number of years?  
**answer**  
```{r}
coaches_names <- masters %>% select("coachID", "firstName", "lastName") %>% filter(!is.na(coachID))
coaches %>% group_by(coachID, tmID) %>%  tally() %>% arrange(desc(n)) %>% inner_join(., coaches_names, by="coachID") %>% mutate(name = paste(firstName, lastName, sep=" ")) %>% head(10) %>% ggplot(aes( reorder(name, -n),n)) + geom_col(aes(fill=tmID)) +theme(axis.text.x = element_text(angle = 45, hjust = 1)) + labs(title = "Longest number of years a coach has been with a team", x="Number of Years", y="Coach")
```

#Question 4  
What coach won the most Stanley Cups?
**answer**  
Scotty Bowman has won the most Stanley Cups, followed by Toe Blake and Hap Day.  
```{r}
question4 = coaches %>% 
  full_join(awardCoaches, by = c("coachID","year","lgID")) %>% 
  filter(lgID == "NHL") %>% 
  full_join(teams, by = c("year","tmID","lgID")) %>% 
  filter(playoff == "SC" ) %>% 
  select(coachID,year,playoff,tmID) %>% 
  group_by(coachID) %>% 
  tally() %>% 
  filter(is.na(coachID)==FALSE) %>% 
  arrange(desc(n))
question4_f = pete %>% 
  left_join(masters, by = c("coachID")) %>% 
  select(coachID,n,firstName,lastName) %>% 
  unite(Name,firstName,lastName, sep = " " )
head(question4_f,3)
```

#Question 5  
What coach had the best full regular season (in terms of number of points per season)?
**answer**  
The total number of possible points for a full regular season is 164 points (2 for a win, 1 for overtime game and 0 for a loss). Therefore, Scotty Bowman had the best full regular season with 131 points in 1995 with the Detroit Red Wings. He is followed by Mike Babcock in 2005 with the Red wings, and by Bruce Boudreau in 2009 with the Washington Capitals.  
```{r}
question5 = coaches %>% 
  full_join(teams, by = c("year","tmID","lgID")) %>% 
  filter(lgID == "NHL",g == 82) %>% 
  select(coachID,year,tmID,lgID,g,w,t) %>% 
  mutate(num_of_points = 2*w +t) %>% 
  left_join(masters, by = "coachID") %>% 
  select(firstName,lastName, tmID,year,num_of_points) %>% 
  unite(Name,firstName,lastName, sep = " " ) %>% 
  arrange(desc(num_of_points))
head(question5,3)
```

#Question 6  
Is there any correlation between regular season and post-season performance?  
**answer**  
It does not appear that there is any correlation between regular seson and post-season performance. The correlation coefficient is 0.289 which implies that the relationship is VERY weak.  
```{r}
question6a = coaches %>% 
  mutate(reg_point_percent = ((2*w+t)/(2*g)), post_point_percent = ((2*postw+postt)/(2*postg))) %>% 
  filter(reg_point_percent > .5)

ggplot(question6a, aes(reg_point_percent, post_point_percent))+
  geom_point()+
  geom_smooth(method = "lm", se = FALSE )

question6b = coaches %>% 
  mutate(reg_point_percent = ((2*w+t)/(2*g)), post_point_percent = ((2*postw+postt)/(2*postg))) %>% 
  filter(reg_point_percent > .5, is.na(reg_point_percent) == FALSE, is.na(post_point_percent) == FALSE)
cor(question6b$post_point_percent,question6b$reg_point_percent)
```

#Question 7  
Coaching tactics that consistently result in a good record?  High PKC / GA (Defensively oriented) or High PPG / GF (Offensively oridented)?  
**answer**  
It appears that there are much more defensively oriented teams than offensively oriented team. This is likely to be due to fact that defensively oriented teams throughout history have had higher mean and median win percentages than offensively oriented team.  
```{r}
question7 <- teams_F %>% 
  mutate(winpercentage = W/G, defense_tendancy = PKC/GA, offense_tendancy = PPG/GF) %>%
  mutate(orientation = ifelse(defense_tendancy > 1.2 | offense_tendancy < .228, "Defense","Offense")) %>% 
  filter(is.na(orientation)==FALSE)

question7i = question7 %>% filter(orientation == "Defense") 
mean(question7i$winpercentage)
median(question7i$winpercentage)
sd(question7i$winpercentage)
question7ii = question7 %>% filter(orientation == "Offense") 
mean(question7ii$winpercentage)
median(question7ii$winpercentage)
sd(question7ii$winpercentage)


ggplot(question7, aes(x = winpercentage))+
  geom_histogram(aes(fill = orientation))
```

