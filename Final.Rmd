---
title: "An Exploration of NHL Coaching Statistics"
name: "Pete Schultz, Tanush Samson, Zach Morales"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Packages

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(rvest)
```

## Introduction
  The datasets used for this project were derived from the Professional Hockey Database from Kaggle (https://www.kaggle.com/open-source-sports/professional-hockey-database). This data, originally sourced from The Hockey Database from Open Source Sports, is a collection of historical statistics from men's professional hockey teams in North America since 1917 until 2011. Althought there were 20 datasets within the source, of which 5 were utilized (masters, coaches, awardCoaches, teams and teamsPost). 

## Data 

```{r,message=FALSE, warning=FALSE}
masters <- read_csv("Data/Master.csv")
coaches <- read_csv("Data/Coaches.csv")
awardCoaches <- read_csv("Data/AwardsCoaches.csv")
teams <- read_csv("Data/Teams.csv")
teamsPost <- read_csv("Data/TeamsPost.csv")

                 
```


```{r,warning=FALSE}
#selecting NHL
teams_F <- teams %>% filter(lgID == "NHL")
teamsPost_F <- teamsPost %>% filter(lgID == "NHL")
```


```{r,warning=FALSE,message=FALSE}
#Coach Awards Data set
awardCoaches2 <- awardCoaches %>% 
  filter(award == "Jack Adams") %>% 
  select(-note)

masters_names <- masters %>% 
  select(coachID, firstName, lastName)

awardCoaches_f <- left_join(awardCoaches2, masters_names)
```


#### Question 1  
How does the team performance change after the coach wins the Jack Adams award?   

**answer**   
We are looking at the teams that had a coach win the Jack Adams during the 5 year period from 1995 to 2000, and how well that team did for the following five years. It appears that no general trend, other than the fact that almost every team does worse the succeeding season, is present for these teams. We are unable to conclude anything further about the performance after a coach wins the Jack Adams.   
```{r, warning=FALSE}
#every coach for every year
Q1 = coaches %>% 
  full_join(awardCoaches, by = c("coachID","year","lgID")) %>% 
  filter(lgID == "NHL") %>% 
  full_join(teams, by = c("year","tmID","lgID")) %>% 
  mutate(won_award = !is.na(award)) %>% 
  select(coachID,year,tmID,g,w,l,t,award,won_award) %>% 
  filter(is.na(coachID)==FALSE, year >= 1995, year <=2000) %>%                   
  arrange(year)


#all the coaches that have won an award
Q1coaches <- Q1 %>% 
  filter(won_award == TRUE) %>% 
  arrange(year)
Q1coaches

#function to create graphs of team's performance after coach wins a Jack Adams award
printPlot <- function(tibble) {
  print(ggplot(tibble, aes(year, ((2*W+T)/(2*G)))) + geom_line() + labs(y ="Points Percentage", title = paste(tibble$tmID[1], "after their coach won Jack Adams award in", tibble$year[1], sep = " ")))
}

#for loop to iterate through teams with coaches that have won an award and plot a graph of their performance for the next 5 years 
for(x in 1:nrow(Q1coaches)){
  teams_F %>%  filter(tmID==Q1coaches$tmID[x] & year >= Q1coaches$year[x] & year <= (Q1coaches$year[x]+5)) %>% printPlot(.)
}


```

 

#Question 2  
How does the team performance change after winning a Stanley Cup?  
**answer**  
In the graph below, the black line represents the percentage of total possible points per game that the team that won the Stanley Cup the previous year earns. The red line represents the minimum required number of points a team needs to make the playoffs. Therefore, since the average points per game for all but one year since 1987 is higher for the reigning league champions than the rest of the NHL, team performance tends to remain high for teams that have just won a Stanley Cup the year before.  
```{r, warning=FALSE, message=FALSE}
#stantley cup champion, year + 1 to be able to join with another dataset
#to see how they do the next year

#filtering for SC champs in modern playoff structure (needs 16 wins to get Stanley cup)
scChamps <- teamsPost %>% 
  filter(year < 2011, W == 16) %>% 
  select(year, tmID) %>% 
  mutate(year = year + 1)

#filtering reg season data and adding a column for Pts %.
#Pts % is the num of pts a team got during the season divided by the total points possible
#1988 is the first year of the modern playoff structure

regSeason <- teams %>%
  select(year, tmID, Pts, G) %>% 
  filter(year > 1987) %>% 
  group_by(year) %>% 
  mutate(PtsPct = Pts/(2*G))

#merging the data sets 
data_f <- left_join(scChamps, regSeason, by = c("year","tmID"))

#points needed for playoffs removing 2004 & 2005 as lockout years
playoffpts <- teams %>%
select(year, tmID, Pts, G, rank) %>%
filter(year > 1987, rank == 4, year != 2004 , year != 2005) %>%
group_by(year) %>%
summarise(PtsForPlayoffs = mean(Pts/ (2*G)))

#joining the data sets to plot our data
data_f <- left_join(data_f, playoffpts)

#visualization
ggplot(data_f) +
  geom_line(aes(year, PtsPct), col = "black") +
  geom_point(aes(year, PtsPct), col = "black") +
  geom_line(aes(year, PtsForPlayoffs), col = "red") +
  geom_point(aes(year, PtsForPlayoffs), col = "red") +
  labs(title = "Previous Year SC Champion Compared to Points Necessary for Playoffs", 
       x = "Year", y = "Points Percentage")
```


```{r}
#filtering for the original six teams and adding the PtsPct variable
origSix <- teams %>% 
  filter(tmID == "BOS" | tmID == "MTL" | tmID == "DET" |
           tmID == "CHI" | tmID == "TOR" | tmID == "NYR") %>% 
  select(year, tmID, G, Pts, playoff, name) %>% 
  mutate(PtsPct = Pts / (2*G))

#filtering the years each team won the Stanley Cup  
SC <- origSix %>% 
  filter(playoff == "SC")

#Visualization utilizing both of the transformed datasets above 
ggplot(origSix, aes(year, PtsPct, col = tmID)) +
  geom_line() +
  geom_point(data = SC, aes(year, PtsPct), col = "black") +
  facet_wrap(~tmID)
```

#### Question 3  
What coach coached the same team for the longest number of years?   

**answer**  
Al Arbour has the record for coaching the same NHL team for the longest number of years (New York Islanders for 20 years), followed by Art Ross with the Boston Bruins for 16 years and Dick Irvins and Jack Adams (Montreal Canadiens and Detroit Red Wings respectively) with 15 years each.   
```{r}
#Create lookup table for team names
teamNames <- teams_F %>% select(c("tmID", "name")) %>% unique() %>% filter(name!="Chicago Black Hawks")

#Create lookup table for coach names
coaches_names <- masters %>% select("coachID", "firstName", "lastName") %>% filter(!is.na(coachID))

#merge coach names with top 10 coaches (by number of years coached a single team)
topCoaches<- coaches %>% group_by(coachID, tmID) %>%  tally() %>% arrange(desc(n)) %>% inner_join(., coaches_names, by="coachID") %>% mutate(nameC = paste(firstName, lastName, sep=" ")) %>% head(10)

#merge team names with tibble of top coaches and create bar chart
topCoaches %>% inner_join(., teamNames, by="tmID") %>% 
  ggplot(aes( reorder(nameC, -n),n)) + geom_col(aes(fill=name)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Longest number of years a coach has been with a team", y="Number of Years", x="Coach") +
  scale_fill_discrete(name="Team")
```

#### Question 4  
What coach won the most Stanley Cups?  

**answer**   
Scotty Bowman has won the most Stanley Cups, followed by Toe Blake and Hap Day.  
```{r}
#merge coaches with awardcoaches and teams
#filter for only stanley cup winners
#tally number of appearances in this data frame of stanley cup winners
question4 = coaches %>% 
  full_join(awardCoaches, by = c("coachID","year","lgID")) %>% 
  filter(lgID == "NHL") %>% 
  full_join(teams, by = c("year","tmID","lgID")) %>% 
  filter(playoff == "SC" ) %>% 
  select(coachID,year,playoff,tmID) %>% 
  group_by(coachID) %>% 
  tally() %>% 
  filter(is.na(coachID)==FALSE) %>% 
  arrange(desc(n))

#merge above dataset with masters to get coaches' names
question4_f = question4 %>% 
  left_join(masters, by = c("coachID")) %>% 
  select(coachID,n,firstName,lastName) %>% 
  unite(Name,firstName,lastName, sep = " " )
head(question4_f,3)

head(question4_f,6) %>% 
  ggplot(aes(reorder(Name,n),factor(n), fill = Name))+
  geom_col()+
  coord_flip()+
  labs(x="Coach", y="Number of Stanley Cups Won", title="Coaches that have won the most amount of Stanley Cups")
```

#### Question 5   
What coach had the best full regular season (in terms of number of points per season)?   

**answer**  
The total number of possible points for a full regular season is 164 points (2 for a win, 1 for overtime game and 0 for a loss). Therefore, Scotty Bowman had the best full regular season with 131 points in 1995 with the Detroit Red Wings. He is followed by Mike Babcock in 2005 with the Red wings, and by Bruce Boudreau in 2009 with the Washington Capitals.  
```{r}
#merge coaches with teams
#filter to have number of games = 82
#join with masters to get coaches names
question5 = coaches %>% 
  full_join(teams, by = c("year","tmID","lgID")) %>% 
  filter(lgID == "NHL",g == 82) %>% 
  select(coachID,year,tmID,lgID,g,w,t,Pts) %>% 
  left_join(masters, by = "coachID") %>% 
  select(firstName,lastName, tmID,year,Pts) %>% 
  unite(Name,firstName,lastName, sep = " " ) %>% 
  arrange(desc(Pts))
head(question5,3)

head(question5,6) %>% 
ggplot( aes(reorder(Name,Pts),Pts)) +
  geom_col(aes(fill=tmID)) +
  labs(title = "Best Full Regular Season by a Coach", y="Number of Points", x="Coach") +
  scale_fill_discrete(name="Team")+
  coord_flip()
```

#### Question 6  
Is there any correlation between regular season and post-season performance?   

**answer**  
It does not appear that there is any correlation between regular seson and post-season performance. The correlation coefficient is 0.289 which implies that the relationship is VERY weak.  
```{r}
question6a = coaches %>% 
  mutate(reg_point_percent = ((2*w+t)/(2*g)), post_point_percent = ((2*postw+postt)/(2*postg))) %>% 
  filter(reg_point_percent > .5)

ggplot(question6a, aes(reg_point_percent, post_point_percent))+
  geom_point()+
  geom_smooth(method = "lm", se = FALSE )

question6b = coaches %>% 
  mutate(reg_point_percent = ((2*w+t)/(2*g)), post_point_percent = ((2*postw+postt)/(2*postg))) %>% 
  filter(reg_point_percent > .5, is.na(reg_point_percent) == FALSE, is.na(post_point_percent) == FALSE)
cor(question6b$post_point_percent,question6b$reg_point_percent)
```


```{r, fig.height=7}
abbrev <- read_csv("Data/abbrev.csv", col_types = "ccf")
abbrevP <- abbrev %>% 
  filter(Type == "Playoffs")

teams %>% 
  filter(year > 1987, rank == 1) %>% 
  left_join(abbrevP, by = c("playoff" = "Code")) %>% 
  ggplot(aes(fct_infreq(Fullname))) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Playoff Round", title = "How far the number 1 team in each division went in the playoffs")
```


#### Question 7  
Coaching tactics that consistently result in a good record?  High PKC / GA (Defensively oriented) or High PPG / GF (Offensively oridented)?    

**answer**  
It appears that there are much more defensively oriented teams than offensively oriented team. This is likely to be due to fact that defensively oriented teams throughout history have had higher mean and median win percentages than offensively oriented team.  
```{r}
#create variables for win percentage, defensive and offensive tendancies
#create variable that classifies each team for each year as either defensively oriented or offensivly oreinted
question7 <- teams_F %>% 
  mutate(winpercentage = W/G, defense_tendancy = PKC/GA, offense_tendancy = PPG/GF) %>%
  mutate(orientation = ifelse(defense_tendancy > 1.2 | offense_tendancy < .228, "Defense","Offense")) %>% 
  filter(is.na(orientation)==FALSE)

##these give the mean, median and sd for each orientation
# question7i = question7 %>% filter(orientation == "Defense") 
# mean(question7i$winpercentage)
# median(question7i$winpercentage)
# sd(question7i$winpercentage)
# question7ii = question7 %>% filter(orientation == "Offense") 
# mean(question7ii$winpercentage)
# median(question7ii$winpercentage)
# sd(question7ii$winpercentage)


ggplot(question7, aes(x = winpercentage))+
  geom_histogram(aes(fill = orientation))
```

